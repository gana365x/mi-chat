const fs = require('fs');
const path = require('path');

const agentsFilePath = path.join(__dirname, 'agents.json');

// Asegura que exista el archivo al iniciar
if (!fs.existsSync(agentsFilePath)) {
  fs.writeFileSync(agentsFilePath, JSON.stringify([]));
}

function getAgents() {
  return JSON.parse(fs.readFileSync(agentsFilePath));
}

function saveAgents(agents) {
  fs.writeFileSync(agentsFilePath, JSON.stringify(agents, null, 2));
}

function createAgent(username, password) {
  const agents = getAgents();
  if (agents.find(a => a.username === username)) {
    return { success: false, message: 'Ya existe ese usuario' };
  }
  agents.push({ username, password, displayName: username, type: 'agent' });
  saveAgents(agents);
  return { success: true };
}

function deleteAgent(username) {
  let agents = getAgents();
  agents = agents.filter(a => a.username !== username);
  saveAgents(agents);
  return { success: true };
}

function getDisplayName(username) {
  const agents = getAgents();
  const found = agents.find(a => a.username === username);
  return found ? found.displayName || username : username;
}

function updateDisplayName(username, newName) {
  const agents = getAgents();
  const index = agents.findIndex(a => a.username === username);
  if (index === -1) return { success: false, message: 'Agente no encontrado' };
  agents[index].displayName = newName;
  saveAgents(agents);
  return { success: true };
}

module.exports = {
  getAgents,
  createAgent,
  deleteAgent,
  getDisplayName,
  updateDisplayName
};

[
  {
    "username": "1",
    "password": "1",
    "displayName": "Agente Uno",
    "type": "agent"
  },
  {
    "username": "2",
    "password": "2",
    "displayName": "Superadmin",
    "type": "superadmin"
  }
