<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Panel de Administración - Gana365</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        input, button { margin: 5px; padding: 8px; }
        #userResult, #addResult { margin-top: 10px; }
        .user-item { padding: 5px; border-bottom: 1px solid #ddd; }
    </style>
</head>
<body>
    <h2>Buscar Cliente por Login</h2>
    <input type="text" id="userSearch" placeholder="Búsqueda del cliente">
    <button onclick="searchUser()">Buscar</button>
    <div id="userResult"></div>

    <h2>Gestión de Fichas</h2>
    <input type="number" id="chipsAmount" placeholder="Cantidad de fichas" min="1">
    <button onclick="addChips()">Agregar Fichas</button>
    <button onclick="removeChips()">Sacar Fichas</button>
    <div id="addResult"></div>

    <script>
        const config = {
            authToken: "2ec45181b469309b3ffd7871677ff198", // Token de autorización para búsqueda
            apiToken: "89c3d37f5b16c3da1ef5af214bfea873d9aed34268b0571a85880bffe300eb6b", // API token para operaciones
            domain: "https://admin.gana365.online",
            cashierId: "1601152" // ID del cajero (Cajatiorico)
        };
        let selectedUser = null;

        // Buscar cliente por login
        async function searchUser() {
            const searchValue = document.getElementById("userSearch").value.toLowerCase().trim();
            console.log("Valor de búsqueda:", searchValue); // Depuración
            let allUsers = [];
            let offset = 0;
            const limit = 1000; // Límite por solicitud (ajustado a 1000)
            let hasMore = true;

            try {
                // Cargar todas las páginas de usuarios
                while (hasMore) {
                    const usersUrl = `${config.domain}/index.php?act=admin&area=users&response=js&token=${config.authToken}&cashier=all&id=${config.cashierId}&limit=${limit}&offset=${offset}`;
                    
                    console.log(`Solicitando URL (offset ${offset}):`, usersUrl); // Depuración
                    
                    const usersResponse = await fetch(usersUrl, { method: "POST" });
                    if (!usersResponse.ok) {
                        console.error(`Error en la solicitud (offset ${offset}):`, usersResponse.status, usersResponse.statusText);
                        break;
                    }
                    
                    const usersData = await usersResponse.json();
                    console.log(`Respuesta completa (offset ${offset}):`, usersData); // Depuración completa
                    
                    const users = usersData.users || [];
                    console.log(`Usuarios cargados (offset ${offset}):`, users); // Depuración
                    
                    allUsers = allUsers.concat(users);
                    offset += limit;
                    hasMore = users.length > 0; // Continuar mientras haya usuarios

                    // Si pageCount está disponible, usarlo para limitar el bucle
                    if (usersData.pageCount) {
                        const totalUsersExpected = usersData.pageCount * limit;
                        console.log(`Total esperado según pageCount: ${totalUsersExpected}`);
                        if (allUsers.length >= totalUsersExpected) {
                            hasMore = false;
                        }
                    }
                }

                console.log("Total de usuarios cargados:", allUsers); // Depuración
                
                const filteredUsers = allUsers.filter(user => {
                    const login = (user.login || "").toLowerCase();
                    console.log(`Comparando login: ${login} con búsqueda: ${searchValue}`); // Depuración
                    return login.includes(searchValue);
                });
                console.log("Usuarios filtrados:", filteredUsers); // Depuración

                const resultDiv = document.getElementById("userResult");
                resultDiv.innerHTML = filteredUsers.length ? 
                    filteredUsers.map(user => 
                        `<div class="user-item">
                            Login: ${user.login || "N/A"} - 
                            Total: ${user.balances?.ARS || "0"} ARS - 
                            Saldo: ${user.out_balance?.ARS || "0"} ARS - 
                            Wager: ${user.wager?.ARS || "0"} ARS 
                            <button onclick="selectUser('${user.id}', '${user.login}')">Seleccionar</button>
                        </div>`
                    ).join("") : 
                    "No se encontraron clientes.";
            } catch (error) {
                document.getElementById("userResult").innerHTML = "Error al buscar clientes.";
                console.error("Error en búsqueda:", error);
            }
        }

        // Seleccionar usuario
        function selectUser(userId, userLogin) {
            selectedUser = { id: userId, login: userLogin };
            document.getElementById("addResult").innerHTML = `Cliente ${userLogin} seleccionado.`;
        }

        // Agregar fichas
        async function addChips() {
            if (!selectedUser) {
                document.getElementById("addResult").innerHTML = "Selecciona un cliente primero.";
                return;
            }
            const amount = document.getElementById("chipsAmount").value;
            if (!amount || amount <= 0) {
                document.getElementById("addResult").innerHTML = "Ingresa una cantidad válida.";
                return;
            }
            
            const url = `${config.domain}/index.php?act=admin&area=balance&type=frame&id=${selectedUser.id}&response=js`;
            const body = `operation=in&send=true&amount=${amount}&balance_currency=ARS&api_token=${config.apiToken}`;
            
            try {
                const response = await fetch(url, {
                    method: "POST",
                    headers: { "Content-Type": "application/x-www-form-urlencoded" },
                    body: body
                });
                const data = await response.json();
                
                document.getElementById("addResult").innerHTML = data.success ? 
                    `${amount} fichas agregadas al cliente ${selectedUser.login}.` : 
                    `Error: ${data.error || "No se pudo agregar fichas."}`;
            } catch (error) {
                document.getElementById("addResult").innerHTML = "Error al agregar fichas.";
            }
        }

        // Sacar fichas
        async function removeChips() {
            if (!selectedUser) {
                document.getElementById("addResult").innerHTML = "Selecciona un cliente primero.";
                return;
            }
            const amount = document.getElementById("chipsAmount").value;
            if (!amount || amount <= 0) {
                document.getElementById("addResult").innerHTML = "Ingresa una cantidad válida.";
                return;
            }
            
            const url = `${config.domain}/index.php?act=admin&area=balance&type=frame&id=${selectedUser.id}&response=js`;
            const body = `operation=out&send=true&amount=${amount}&balance_currency=ARS&api_token=${config.apiToken}`;
            
            try {
                const response = await fetch(url, {
                    method: "POST",
                    headers: { "Content-Type": "application/x-www-form-urlencoded" },
                    body: body
                });
                const data = await response.json();
                
                document.getElementById("addResult").innerHTML = data.success ? 
                    `${amount} fichas retiradas del cliente ${selectedUser.login}.` : 
                    `Error: ${data.error || "No se pudo sacar fichas."}`;
            } catch (error) {
                document.getElementById("addResult").innerHTML = "Error al sacar fichas.";
            }
        }
    </script>
</body>
</html>
