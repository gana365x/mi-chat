<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Panel de Administración - Gana365</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    input, button { margin: 5px; padding: 8px; }
    #userResult, #addResult, .popup { margin-top: 10px; }
    .user-item { padding: 5px; border-bottom: 1px solid #ddd; }

    .popup {
      position: fixed;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%);
      background-color: #333;
      color: white;
      padding: 12px 24px;
      border-radius: 5px;
      opacity: 0;
      transition: opacity 0.4s ease;
      z-index: 9999;
    }

    .popup.success { background-color: green; }
    .popup.error { background-color: crimson; }
    .popup.show { opacity: 1; }
  </style>
</head>
<body>
  <h2>Buscar Cliente por Login</h2>
  <input type="text" id="userSearch" placeholder="Búsqueda del cliente">
  <button onclick="searchUser()">Buscar</button>
  <div id="userResult"></div>

  <h2>Gestión de Fichas</h2>
  <input type="number" id="chipsAmount" placeholder="Cantidad de fichas" min="1">
  <button onclick="addChips()">Agregar Fichas</button>
  <button onclick="removeChips()">Sacar Fichas</button>
  <div id="addResult"></div>

  <div id="popup" class="popup"></div>

  <script>
    const config = {
      authToken: "59b834e29d7837b810c04fde2bda4d09",
      apiToken: "89c3d37f5b16c3da1ef5af214bfea873d9aed34268b0571a85880bffe300eb6b",
      domain: "https://admin.gana365.online",
      cashierId: "1601152"
    };

    let selectedUser = null;

    function showPopup(message, type = "success") {
      const popup = document.getElementById("popup");
      popup.className = `popup ${type} show`;
      popup.textContent = message;
      setTimeout(() => popup.classList.remove("show"), 3000);
    }

    async function searchUser(loginToFind = null) {
      const searchValue = loginToFind || document.getElementById("userSearch").value.toLowerCase().trim();
      let foundUser = null;
      const limit = 1000;
      const batchSize = 20;
      let offset = 0;
      let hasMore = true;

      try {
        while (hasMore && !foundUser) {
          const offsets = Array.from({ length: batchSize }, (_, i) => offset + i);
          const userPromises = offsets.map(async (batchOffset) => {
            const url = `${config.domain}/index.php?act=admin&area=users&response=js&token=${config.authToken}&cashier=all&id=${config.cashierId}&limit=${limit}&offset=${batchOffset}`;
            try {
              const res = await fetch(url, { method: "POST" });
              if (!res.ok) return { users: [], offset: batchOffset };
              const data = await res.json();
              return { users: data.users || [], offset: batchOffset };
            } catch {
              return { users: [], offset: batchOffset };
            }
          });

          const usersArrays = await Promise.all(userPromises);

          for (const { users } of usersArrays) {
            const userMatch = users.find(user => user.login?.toLowerCase() === searchValue);
            if (userMatch) {
              foundUser = userMatch;
              break;
            }
            if (users.length === 0) {
              hasMore = false;
              break;
            }
          }

          if (!foundUser) offset += batchSize;
        }

        const resultDiv = document.getElementById("userResult");
        if (foundUser) {
          selectedUser = { id: foundUser.id, login: foundUser.login };
          document.getElementById("addResult").innerHTML = `Cliente ${selectedUser.login} seleccionado.`;

          resultDiv.innerHTML = `
            <div class="user-item">
              <strong>Login:</strong> ${foundUser.login}<br>
              <strong>Total:</strong> ${foundUser.balances?.ARS || "0"} ARS<br>
              <strong>Retirable:</strong> ${foundUser.out_balance?.ARS || "0"} ARS<br>
              <strong>Wager restante:</strong> ${foundUser.limit?.ARS || "0"} ARS
            </div>`;
        } else {
          selectedUser = null;
          resultDiv.innerHTML = "No se encontró ningún usuario con ese login.";
        }
      } catch {
        document.getElementById("userResult").innerHTML = "Error al buscar clientes.";
      }
    }

    async function addChips() {
      await sendChips("in");
    }

    async function removeChips() {
      await sendChips("out");
    }

    async function sendChips(operation) {
      if (!selectedUser) {
        showPopup("Selecciona un cliente primero.", "error");
        return;
      }

      const amount = document.getElementById("chipsAmount").value;
      if (!amount || amount <= 0) {
        showPopup("Ingresa una cantidad válida.", "error");
        return;
      }

      const url = `${config.domain}/index.php?act=admin&area=balance&type=frame&id=${selectedUser.id}&response=js`;
      const body = `operation=${operation}&send=true&amount=${amount}&balance_currency=ARS&api_token=${config.apiToken}`;

      try {
        const res = await fetch(url, {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body
        });

        const data = await res.json();

        if (data.success || data.message?.includes("success") || res.status === 200) {
          showPopup(`Fichas ${operation === "in" ? "agregadas" : "retiradas"} correctamente.`, "success");

          // Esperamos 1.5 segundos antes de actualizar para que el backend refleje los cambios
          setTimeout(() => {
            searchUser(selectedUser.login);
          }, 1500);
        } else {
          showPopup(`Error: ${data.error || "No se pudo completar la operación."}`, "error");
        }

      } catch (err) {
        console.error("Error en la solicitud:", err);
        showPopup("Error de conexión con el servidor.", "error");
      }
    }
  </script>
</body>
</html>
