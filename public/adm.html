<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Panel de Administración - Gana365</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        input, button { margin: 5px; padding: 8px; }
        #userResult, #addResult { margin-top: 10px; }
        .user-item { padding: 5px; border-bottom: 1px solid #ddd; }
    </style>
</head>
<body>
    <h2>Buscar Cliente por Login</h2>
    <input type="text" id="userSearch" placeholder="Login del cliente (ej. yonathan369)">
    <button onclick="searchUser()">Buscar</button>
    <div id="userResult"></div>

    <h2>Gestión de Fichas</h2>
    <input type="number" id="chipsAmount" placeholder="Cantidad de fichas" min="1">
    <button onclick="addChips()">Agregar Fichas</button>
    <button onclick="removeChips()">Sacar Fichas</button>
    <div id="addResult"></div>

    <script>
        const config = {
            token: "2ec45181b469309b3ffd7871677ff198", // Token de autorización
            domain: "https://admin.gana365.online"
        };
        let selectedUserId = null;

        // Buscar cliente por login y obtener balance/wager
        async function searchUser() {
            const searchValue = document.getElementById("userSearch").value.toLowerCase();
            const usersUrl = `${config.domain}/index.php?act=admin&area=users&response=js&token=${config.token}&limit=100`;
            
            try {
                // Obtener lista de usuarios
                const usersResponse = await fetch(usersUrl, { method: "POST" });
                const usersData = await usersResponse.json();
                
                const users = usersData.users || [];
                const filteredUsers = users.filter(user => 
                    (user.login || "").toLowerCase().includes(searchValue)
                );

                // Obtener balance y wager para cada usuario filtrado
                const userDetails = await Promise.all(filteredUsers.map(async (user) => {
                    const balanceUrl = `${config.domain}/index.php?act=admin&area=balance&response=js&token=${config.token}&id=${user.id}`;
                    const balanceResponse = await fetch(balanceUrl, { method: "POST" });
                    const balanceData = await balanceResponse.json();
                    
                    // Mostrar respuesta cruda en consola para depurar
                    console.log(`Respuesta de balance para ID ${user.id}:`, balanceData);
                    
                    return {
                        id: user.id,
                        login: user.login,
                        balance: balanceData.balance || balanceData.amount || "0", // Intento con 'balance' o 'amount'
                        wager: balanceData.wager || "0" // 'wager' parece correcto
                    };
                }));
                
                const resultDiv = document.getElementById("userResult");
                resultDiv.innerHTML = userDetails.length ? 
                    userDetails.map(user => 
                        `<div class="user-item">
                            ID: ${user.id} - 
                            Login: ${user.login || "N/A"} - 
                            Balance: ${user.balance} ARS - 
                            Wager: ${user.wager} 
                            <button onclick="selectUser('${user.id}')">Seleccionar</button>
                        </div>`
                    ).join("") : 
                    "No se encontraron clientes.";
            } catch (error) {
                document.getElementById("userResult").innerHTML = "Error al buscar clientes.";
                console.error("Error en búsqueda:", error);
            }
        }

        // Seleccionar usuario
        function selectUser(userId) {
            selectedUserId = userId;
            document.getElementById("addResult").innerHTML = `Cliente ${userId} seleccionado.`;
        }

        // Agregar fichas
        async function addChips() {
            if (!selectedUserId) {
                document.getElementById("addResult").innerHTML = "Selecciona un cliente primero.";
                return;
            }
            const amount = document.getElementById("chipsAmount").value;
            if (!amount || amount <= 0) {
                document.getElementById("addResult").innerHTML = "Ingresa una cantidad válida.";
                return;
            }
            
            const url = `${config.domain}/index.php?act=admin&area=balance&type=frame&id=${selectedUserId}&response=js&token=${config.token}`;
            const body = `amount=${amount}`;
            
            try {
                const response = await fetch(url, {
                    method: "POST",
                    headers: { "Content-Type": "application/x-www-form-urlencoded" },
                    body: body
                });
                const data = await response.json();
                
                document.getElementById("addResult").innerHTML = data.success ? 
                    `${amount} fichas agregadas al cliente ${selectedUserId}.` : 
                    `Error: ${data.error || "No se pudo agregar fichas."}`;
            } catch (error) {
                document.getElementById("addResult").innerHTML = "Error al agregar fichas.";
            }
        }

        // Sacar fichas
        async function removeChips() {
            if (!selectedUserId) {
                document.getElementById("addResult").innerHTML = "Selecciona un cliente primero.";
                return;
            }
            const amount = document.getElementById("chipsAmount").value;
            if (!amount || amount <= 0) {
                document.getElementById("addResult").innerHTML = "Ingresa una cantidad válida.";
                return;
            }
            
            const url = `${config.domain}/index.php?act=admin&area=balance&type=frame&id=${selectedUserId}&response=js&token=${config.token}`;
            const body = `amount=-${amount}`; // Negativo para sacar
            
            try {
                const response = await fetch(url, {
                    method: "POST",
                    headers: { "Content-Type": "application/x-www-form-urlencoded" },
                    body: body
                });
                const data = await response.json();
                
                document.getElementById("addResult").innerHTML = data.success ? 
                    `${amount} fichas retiradas del cliente ${selectedUserId}.` : 
                    `Error: ${data.error || "No se pudo sacar fichas."}`;
            } catch (error) {
                document.getElementById("addResult").innerHTML = "Error al sacar fichas.";
            }
        }
    </script>
</body>
</html>
